<html>
<head>
<meta charset="UTF-8"/>
<title>Relat√≥rio</title>
<link rel="stylesheet" type="text/css" href="css/style.css">
<script type="text/javascript" src="js/jquery.js"></script>
<link rel="canonical" href="https://getbootstrap.com/docs/5.1/examples/dashboard/">
<link href="./bootstrap/css/bootstrap.min.css" rel="stylesheet">
<script type="text/javascript" src="js/clock.js"></script>
<script type="text/javascript" src="js/endSessionUser.js"></script>
</head>
<body>
    <div class="back">
        <div class="headers"></div>
        <div class="content">
            <div id="select_box">
                <div id="select_box_left">
                    <select id="search_select" class="search_select" onchange="search_alert(this.value)">
                        <option value="Apartamento">Apartamento</option>
                        <option value="Data">Data</option>
                        </select>
                        <div class="busca_label">Selecione o modo de busca</div>
                </div>
                <div id="select_box_right">
                    <div id="filtro" class="alertdiv"></div>
                </div>
                </div>
                <div id="table"></div>
            </div>
            <div class="footer">
                <div class="bottom_button">
                    <input id="voltar" type="button" class="button" value="Voltar">
                    <input type="button" class="button" id="lupa" value="Buscar" onclick="search()">
                    <input type="button" class="button" id="download" value="Download">
                </div>
            </div>
        </div>

    </div>
    <script src="./bootstrap/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="./js/FileSaver/FileSaver.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js" type="text/javascript"></script>
    <script>
var ip = getIP();

var retorno;
var count_campos = 0;

async function search_alert(message) {
console.log(message)
document.querySelector(".search_select").value = "";
var exists_txt = document.querySelector(`#${message}`);
var exists_btn = document.querySelector("#lupa");
if(exists_txt){
  return
} else if (message==="Apartamento"){
  count_campos = count_campos + 1;

$('#filtro').append(`
<div id="${message}">
<div prop="alertobj" class="alert alert alert-dismissible" role="alert">
<div id="ap_label" class="busca_label">Apartamento</div>
<select id="ap_select" class="txt"></select>
<button id="select_${message}" prop="alertbtn" type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close" onclick="clear_lupa(this.id)">
</div>
</div>
`)  
//-------------------FETCH SERVER PARA CARREGAR TODOS OS MESES -----------------
var ip = await getIP();
const data_call = {sessionId,token,ip}
const options = {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(data_call)
};
const response = await fetch(server+'/db_ap',options);
const data = await response.json();
//-------------------FOREACH PARA PREENCHER O SELECT COM OS FORNECEDORES-----------------
data.forEach(function(ap){
    $('#ap_select').append(`<option value="${ap.ap}">${ap.ap}</option>`);  
})
document.querySelector('#ap_select').value = "";

} else if (message==="Data"){
  count_campos = count_campos + 1;
$('#filtro').append(`
<div id="${message}">
<div prop="alertobj" class="alert alert alert-dismissible" role="alert">
<div id="data_inicial_label" class="busca_label">Data inicial</div>
<input type="date" id="${message}-from" class="alerttxt">
<div id="data_final_label" class="busca_label">Data final</div>
<input type="date" id="${message}-to" class="alerttxt">
<button id="select_${message}" prop="alertbtn" type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close" onclick="clear_lupa(this.id)">
</div>
</div>
`)
} else {
  count_campos = count_campos + 1;
  $('#filtro').append(`
  <div prop="alertobj" class="alert alert alert-dismissible" role="alert">
  ${message}
  <input id="${message}" class="alerttxt" type="text">
  <button id="select_${message}" prop="alertbtn" type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close">
  </div>
  `)
}

}

function clear_lupa(id_raw){

var id = "#"+id_raw.substring(7)

$(id).remove();

count_campos = count_campos - 1;
}

async function search(){
    $('#table').html("");
    
    const ap_select = document.querySelector('#ap_select')
    const data_from_select = document.querySelector('#Data-from')
    const data_to_select = document.querySelector('#Data-to')

    var ap;
    var data_from;
    var data_to;

    if(ap_select){
        var ap = ap_select.value;
    } else {
        ap = false
    }

    if(data_from_select){
        var data_from_raw = new Date(data_from_select.value);
        data_from = data_from_raw.getTime();
    } else {
        data_from = false
    }

    if(data_to_select){
        var data_to_raw = new Date(data_to_select.value);
        data_to = data_to_raw.getTime()
    } else {
        data_to = false
    }

    clear_lupa("select_Apartamento");

    clear_lupa("select_Data");

    var route;

    var ip = await getIP();
    
if(ap && !data_from){
data = {ap,sessionId,token,ip}
route = '/log/correios/ap'
} else if(!ap && data_from){
data = {data_from,data_to,sessionId,token,ip}
route = '/log/correios/data'
} else if(ap && data_from){
data = {ap,data_from,data_to,sessionId,token,ip}
route = '/log/correios/ap_data'
} else {
data = {sessionId,token,ip};
route = '/log/correios'
}

const options = {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(data)
};

var response;


console.log(route)
response = await fetch(server+route, options);
retorno = await response.json();
console.log(retorno)

$('#table').append(`
<div class="table-responsive">
  <table id="log_table" class="table table-striped table-sm">
  <thead>
  <tr class="celula">
    <th scope="col">Carteiro</th>
    <th scope="col">ID da Entrega</th>
    <th scope="col">Apartamento</th>
    <th scope="col">Compartimento</th>
    <th scope="col">Data Entrega</th>
    <th scope="col">Hora Entrega</th>
    <th scope="col">Data Retirada</th>
    <th scope="col">Hora Retirada</th>
    <th scope="col"></th>
  </tr>
  </thead>
  <tbody id="table_body">
  </tbody>
  </table>
</div>
`)

$('#table_body').html("");
  
  var length = retorno.length;

  for(i=0;i<length;i++){

    var carteiro = retorno[i].credencial;
    var entregaId = retorno[i].entregaId; 
    var ap = retorno[i].ap;
    var comp = retorno[i].comp;
    var data_entrega = retorno[i].data_entrega;
    var hora_entrega = retorno[i].hora_entrega;
    var data_retirada = retorno[i].data_retirada;
    var hora_retirada = retorno[i].hora_retirada;

    
  $('#table_body').append(`
  <tr class="celula">
    <td>${carteiro}</td>
    <td>${entregaId}</td>
    <td>${ap}</td>
    <td>${comp}</td>
    <td>${data_entrega}</td>
    <td>${hora_entrega}</td>
    <td>${data_retirada}</td>
    <td>${hora_retirada}</td>
    <td>
    </td>
  </tr>
  `); 
}
}

$('#voltar').click(function(){
    window.location.replace("correios.html");
})

$('#download').click(function (){
    const JSONToCSV = (objArray, keys) => [
        keys.join(','), ...objArray.map(
            row => keys.map(k => row[k] || '')
                .join(','))].join('\n');

const texto = JSONToCSV(retorno,
['credencial', 'entregaId', 'ap', 'comp', 'data_entrega', 'hora_entrega', 'data_retirada', 'hora_retirada']);                

console.log(texto);
salvar(texto)
})

function salvar(texto) {
      var titulo = "Log";
      var blob = new Blob([texto], { type: "text/plain;charset=utf-8" });
      saveAs(blob, titulo + ".txt");
   }

   createDiv();
    </script>